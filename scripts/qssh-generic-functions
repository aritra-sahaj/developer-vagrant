#!/bin/bash

set -Eeuo pipefail

KEYS_DIR="${SSH_KEYS_DIR:-${HOME}/.ssh-keys}"

function newline() {
  echo ""
}

function all_instances_details() {
  local -n all_instances_details=${1}
  all_instances_details=$(aws ec2 describe-instances --filters "Name=instance-state-code,Values=16" | jq -c '.Reservations | {instances: map(.Instances) | add} | .instances |=map({id: .InstanceId, key: .KeyName, name: .Tags[] | select(.Key=="Name") | .Value, vpc_id: .VpcId, private_ip: .NetworkInterfaces[0].PrivateIpAddress, public_ip: .NetworkInterfaces[0].Association.PublicIp}) | .instances |=sort_by(.name) | .instances')
}

function empty_check() {
  local instances_details="${1}"
  local message="${2}"
  if [[ $(echo -n "${instances_details}" | jq 'length') -eq 0 ]]; then
    newline
    echo "${message}"
    exit 1
  fi
}

function print_instance_detail() {
  local indexed_instances_details="${1}"
  local instance_index="${2}"
  instance_details=$(echo -n "${indexed_instances_details}" | jq -r ".[${instance_index}] | {detail: ((.name | gsub(\"[[:space:]]+\"; \"SPACE\")) + \"|\" + .public_ip + \"|\" + .private_ip )} | .detail")
  name=$(echo -n "${instance_details}" | cut -d '|' -f 1 | sed 's|SPACE| |g')
  public_ip=$(echo -n "${instance_details}" | cut -d '|' -f 2)
  private_ip=$(echo -n "${instance_details}" | cut -d '|' -f 3)
  [[ -z "${public_ip}" ]] && instance_ip="${private_ip}" || instance_ip="${public_ip}"
  echo "${name} (${instance_ip})"
}

function print_instance_choice_options() {
  local indexed_instances_details="${1}"
  local message="${2}"
  local max_index_length=$(($(echo -n "${indexed_instances_details}" | jq '. | map(.index | tostring | length) | max') + 1))
  local max_name_length=$(($(echo -n "${indexed_instances_details}" | jq '. | map(.name | length) | max') + 1))
  newline
  echo "${message}"
  newline
  for option in $(echo -n "${indexed_instances_details}" | jq -r ".[] | {detail: ((.index|tostring) + \".|\" + (.name | gsub(\"[[:space:]]+\"; \"SPACE\")) + \"|\" + .public_ip + \"|\" + .private_ip )} | .detail")
  do
    index=$(echo -n "${option}" | cut -d '|' -f 1)
    name=$(echo -n "${option}" | cut -d '|' -f 2 | sed 's|SPACE| |g')
    public_ip=$(echo -n "${option}" | cut -d '|' -f 3)
    private_ip=$(echo -n "${option}" | cut -d '|' -f 4)
    [[ -z "${public_ip}" ]] && instance_ip="${private_ip}" || instance_ip="${public_ip}"
    padded_index=$(printf %"${max_index_length}"s "${index}")
    padded_name=$(printf %-"${max_name_length}"s "${name}")
    echo " ${padded_index} ${padded_name} (${instance_ip})"
  done
}

function select_and_set_instance_details_in_vars() {
  local -n instance_ip=${1}
  local -n instance_key=${2}
  local -n instance_user=${3}
  local -n instance_vpc=${4}
  local -n use_bastion=${5}
  local instances_details=${6}
  local context=${7}
  local action=${8}
  indexed_instances_details=$(echo -n "${instances_details}" | jq -c ". | to_entries | map({index:.key, id:.value.id, key:.value.key, name:.value.name, vpc_id:.value.vpc_id, private_ip:.value.private_ip, public_ip:.value.public_ip})")
  if [[ $(echo -n "${indexed_instances_details}" | jq 'length') -eq 1 ]]; then
    newline
    instance_index="0"
    echo "Connecting ${action} ${context} instance - $(print_instance_detail "${indexed_instances_details}" "${instance_index}")"
  else
    print_instance_choice_options "${indexed_instances_details}" "Choose a ${context} instance to connect ${action}."
    capture_argument_with_default instance_index "Instance" "0"
  fi
  public_ip=$(echo -n "${indexed_instances_details}" | jq -r ".[] | select(.index == ${instance_index}) | .public_ip")
  private_ip=$(echo -n "${indexed_instances_details}" | jq -r ".[] | select(.index == ${instance_index}) | .private_ip")
  if [[ "${public_ip}" == "null" ]]; then
    use_bastion="y"
    instance_ip="${private_ip}"
  else
    use_bastion="n"
    instance_ip="${public_ip}"
  fi
  instance_key_pair=$(echo -n "${indexed_instances_details}" | jq -r ".[] | select(.index == ${instance_index}) | .key")
  instance_name=$(echo -n "${indexed_instances_details}" | jq -r ".[] | select(.index == ${instance_index}) | .name")
  lookup_key instance_key "${instance_key_pair}" "${instance_name}"
  instance_user instance_user "${instance_name}"
  instance_vpc=$(echo -n "${indexed_instances_details}" | jq -r ".[] | select(.index == ${instance_index}) | .vpc_id")
}

function filter_instances_details() {
  local -n filtered_instances_details=${1}
  local instances_details="${2}"
  filtered_instances_details=$(echo -n "${instances_details}")
  for search_string in "${@:3}"
  do
    filtered_instances_details=$(echo -n "${filtered_instances_details}" | jq -c ". | map(select(.name | ascii_downcase | contains(\"$(echo "${search_string}" | tr '[:upper:]' '[:lower:]')\")))")
  done
}

function filter_public_instances_details() {
  local -n filtered_instances_details=${1}
  local instances_details="${2}"
  filtered_instances_details=$(echo -n "${instances_details}" | jq -c '. | map(select(.public_ip))')
}

function filter_vpc_instances_details() {
  local -n filtered_instances_details=${1}
  local instances_details="${2}"
  local vpc_id="${3}"
  filtered_instances_details=$(echo -n "${instances_details}" | jq -c ". | map(select(.vpc_id == \"${vpc_id}\"))")
}

function capture_argument() {
  local -n argument=${1}
  local message=${2}
  newline
  read -r -p "${message}: " argument
}

function capture_argument_with_default() {
  local -n argument=${1}
  local message=${2}
  local default_value=${3}
  newline
  read -r -p "${message} (${default_value}): " argument
  argument=${argument:-${default_value}}
}

function set_instance_details_in_vars() {
  local -n instance_ip=${1}
  local -n instance_key=${2}
  local -n instance_user=${3}
  local -n instance_vpc=${4}
  local -n use_bastion=${5}
  local instance_details="${6}"
  public_ip=$(echo -n "${instance_details}" | jq -r ".public_ip")
  private_ip=$(echo -n "${instance_details}" | jq -r ".private_ip")
  if [[ "${public_ip}" == "null" ]]; then
    use_bastion="y"
    instance_ip="${private_ip}"
  else
    use_bastion="n"
    instance_ip="${public_ip}"
  fi
  instance_key_pair=$(echo -n "${instance_details}" | jq -r ".key")
  instance_name=$(echo -n "${instance_details}" | jq -r ".name")
  lookup_key instance_key "${instance_key_pair}" "${instance_name}"
  instance_user instance_user "${instance_name}"
  instance_vpc=$(echo -n "${instance_details}" | jq -r ".vpc_id")
}

function print_batch_confirmation() {
  local instances_details="${1}"
  local message="${2}"

  newline
  echo "${message}"
  newline

  for option in $(echo -n "${instances_details}" | jq -r ".[] | .name | gsub(\"[[:space:]]+\"; \"SPACE\")")
  do
    name=$(echo -n "${option}" | sed 's|SPACE| |g')
    echo " - ${name}"
  done

  local confirmation_default="y"
  newline
  read -p "Proceed [y/n]? (y): " -n 1 confirmation
  confirmation=$(echo -n "${confirmation:-${confirmation_default}}" | tr '[:upper:]' '[:lower:]')
  if [[ "${confirmation}" != "y" ]]; then
    exit 1
  fi
}

function lookup_key() {
  local -n key_path=${1}
  local key_pair="${2}"
  local instance_name="${3}"
  local key_pair_fingerprint=$(aws ec2 describe-key-pairs --key-names "${key_pair}" | jq -r '.KeyPairs[0].KeyFingerprint')
  for key_file in $(find ${KEYS_DIR} -type f); do
    if [[ "${key_file}" != *".pub" ]]; then
      key_file_fingerprint=$(openssl pkcs8 -in "${key_file}" -nocrypt -topk8 -outform DER | openssl sha1 -c | awk '{print $2}')
      if [[ "${key_pair_fingerprint}" == "${key_file_fingerprint}" ]]; then
        key_path="${key_file}"
        break
      fi
    fi
  done
  if [[ -z "${key_path-}" ]]; then
    capture_argument key_path "Path to key for ${instance_name}"
  fi
}

function known_user() {
  local -n known_user_name=${1}
  local instance_name=$(echo -n "${2}" | tr '[:upper:]' '[:lower:]')
  known_user_name=""
}

function instance_user() {
  local -n user_name=${1}
  local instance_name="${2}"
  known_user user_name "${instance_name}"
  if [[ -z "${user_name-}" ]]; then
    capture_argument_with_default user_name "User for ${instance_name}" "ubuntu"
  fi
}

function choose_bastion() {
  local -n bastion_ip=${1}
  local -n bastion_key=${2}
  local -n bastion_user=${3}
  local all_instances_details="${4}"
  local target_vpc_id="${5}"
  filter_public_instances_details possible_bastion_instances_details "${all_instances_details}"
  filter_vpc_instances_details possible_bastion_instances_details "${possible_bastion_instances_details}" "${target_vpc_id}"
  empty_check "${possible_bastion_instances_details}" "No bastion instances found"
  select_and_set_instance_details_in_vars bastion_ip bastion_key bastion_user bastion_vpc ignore_use_bastion \
    "${possible_bastion_instances_details}" "bastion" "through"
}